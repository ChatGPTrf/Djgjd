<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Звонки по юзернейму — WebRTC</title>
  <style>
    :root{--bg:#f7fafc;--card:#fff;--muted:#6b7280;--accent:#0f172a;}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:20px;background:var(--bg);color:#111;}
    .wrap{max-width:980px;margin:0 auto;display:grid;gap:14px;}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 1px 3px rgba(2,6,23,0.06);}
    header h1{margin:0;font-size:20px}
    label{display:block;margin-top:10px;color:var(--muted);font-size:13px}
    input[type="text"], input[type="url"]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ee;margin-top:6px;font-size:14px;}
    .row{display:flex;gap:8px;margin-top:10px}
    button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer;font-weight:600}
    button.secondary{background:#e6e9ee;color:#111}
    .videos{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    video{width:100%;height:260px;background:#000;border-radius:8px;object-fit:cover}
    .log{max-height:200px;overflow:auto;background:#f1f5f9;border-radius:8px;padding:8px;font-size:12px;margin-top:8px}
    .muted{color:var(--muted)}
    @media (max-width:720px){ .videos{grid-template-columns:1fr;} .row{flex-direction:column} video{height:200px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Звонки по юзернейму — WebRTC</h1>
      <div class="muted">Статический клиент. Нужен signaling-сервер по WSS (TLS). Инструкции ниже.</div>
    </header>

    <section class="card">
      <label>Signaling WebSocket URL (WSS)</label>
      <input id="wsUrl" type="url" placeholder="wss://example.com" value="wss://YOUR_DOMAIN">
      <label>Ваш username</label>
      <input id="username" type="text" placeholder="alice">
      <div class="row">
        <button id="connectBtn">Connect & Register</button>
        <button id="disconnectBtn" class="secondary">Disconnect</button>
      </div>

      <label style="margin-top:14px">Target username (кому звоните)</label>
      <input id="target" type="text" placeholder="bob">
      <div class="row">
        <button id="callBtn">Call</button>
        <button id="hangupBtn" class="secondary">Hang up</button>
      </div>

      <div style="margin-top:12px" class="muted">
        <ul style="margin:6px 0 0 18px">
          <li>GitHub Pages — HTTPS. Signaling должен быть WSS (TLS) — иначе браузер блокирует соединение.</li>
          <li>Для лучшей работоспособности в разных сетях добавьте TURN (coturn) в конфиг ICE.</li>
        </ul>
      </div>
    </section>

    <section class="card">
      <div class="videos">
        <div>
          <div class="muted">Вы</div>
          <video id="localVideo" autoplay muted playsinline></video>
        </div>
        <div>
          <div class="muted">Собеседник</div>
          <video id="remoteVideo" autoplay playsinline></video>
        </div>
      </div>
      <div style="margin-top:12px">
        <div class="muted">Лог</div>
        <div id="log" class="log"></div>
      </div>
    </section>

    <footer class="card muted">
      <div>После деплоя signaling-сервера подставьте его WSS URL в поле выше и нажмите <b>Connect & Register</b>.</div>
    </footer>
  </div>

<script>
/* Клиент WebRTC + signaling по username
   Протокол сообщений (JSON):
   - {type:'register', username}
   - {type:'registered', username}
   - {type:'offer', from, to, sdp}
   - {type:'answer', from, to, sdp}
   - {type:'ice-candidate', from, to, candidate}
*/

(function(){
  const wsUrlEl = document.getElementById('wsUrl');
  const usernameEl = document.getElementById('username');
  const targetEl = document.getElementById('target');
  const connectBtn = document.getElementById('connectBtn');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const callBtn = document.getElementById('callBtn');
  const hangupBtn = document.getElementById('hangupBtn');
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');
  const logEl = document.getElementById('log');

  let ws = null;
  let pc = null;
  let localStream = null;

  function log(msg){
    const d = document.createElement('div');
    d.textContent = new Date().toLocaleTimeString() + ' — ' + msg;
    logEl.appendChild(d);
    logEl.scrollTop = logEl.scrollHeight;
    console.info(msg);
  }

  function send(obj){
    if(!ws || ws.readyState !== WebSocket.OPEN){ log('WebSocket не подключён'); return; }
    ws.send(JSON.stringify(obj));
    log('>> ' + JSON.stringify(obj));
  }

  function connectAndRegister(){
    const url = wsUrlEl.value.trim();
    const username = usernameEl.value.trim();
    if(!url){ log('Укажите WSS URL'); return; }
    if(!username){ log('Введите username'); return; }

    if(ws && ws.readyState === WebSocket.OPEN){
      log('WebSocket уже открыт, регистрирую...');
      send({type:'register', username});
      return;
    }

    try {
      ws = new WebSocket(url);
    } catch (e) {
      log('Ошибка создания WebSocket: ' + e.message);
      return;
    }

    ws.onopen = () => {
      log('WebSocket connected');
      send({type:'register', username});
    };

    ws.onmessage = async (ev) => {
      let msg;
      try { msg = JSON.parse(ev.data); } catch(e){ log('Bad WS JSON'); return; }
      log('<< ' + JSON.stringify(msg));
      if(msg.type === 'registered'){
        log('Зарегистрированы как ' + msg.username);
        return;
      }
      if(msg.type === 'offer'){
        await onOffer(msg);
        return;
      }
      if(msg.type === 'answer'){
        await onAnswer(msg);
        return;
      }
      if(msg.type === 'ice-candidate'){
        await onRemoteIce(msg);
        return;
      }
      if(msg.type === 'error'){
        log('Server error: ' + (msg.reason || JSON.stringify(msg)));
      }
    };

    ws.onclose = () => { log('WebSocket closed'); ws = null; };
    ws.onerror = (e) => { log('WebSocket error'); };
  }

  function disconnectWs(){
    if(ws) ws.close();
    ws = null;
    log('Disconnected');
  }

  async function startLocal(){
    if(localStream) return localStream;
    try {
      localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
      localVideo.srcObject = localStream;
      return localStream;
    } catch (e) {
      log('getUserMedia failed: ' + e.message);
      throw e;
    }
  }

  function createPc(){
    if(pc) return pc;
    pc = new RTCPeerConnection({
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }
        // Для продакшена добавьте TURN сюда:
        // { urls:'turn:turn.example:3478', username:'user', credential:'pass' }
      ]
    });

    pc.onicecandidate = (e) => {
      if(e.candidate){
        send({type:'ice-candidate', from: usernameEl.value.trim(), to: targetEl.value.trim(), candidate: e.candidate});
      }
    };

    pc.ontrack = (e) => {
      log('Remote track received');
      remoteVideo.srcObject = e.streams[0];
    };

    pc.onconnectionstatechange = () => {
      log('PC state: ' + pc.connectionState);
      if(pc.connectionState === 'disconnected' || pc.connectionState === 'closed' || pc.connectionState === 'failed'){
        // очистка
      }
    };

    return pc;
  }

  async function call(){
    const from = usernameEl.value.trim();
    const to = targetEl.value.trim();
    if(!from || !to){ log('Введите both usernames'); return; }
    if(!ws || ws.readyState !== WebSocket.OPEN){ log('WebSocket не подключён — подключаюсь...'); connectAndRegister(); return; }

    await startLocal();
    const localPc = createPc();
    localStream.getTracks().forEach(t => localPc.addTrack(t, localStream));

    const offer = await localPc.createOffer();
    await localPc.setLocalDescription(offer);
    send({type:'offer', from, to, sdp: localPc.localDescription});
  }

  async function onOffer(msg){
    const from = msg.from;
    log('Получен offer от ' + from);
    targetEl.value = from;
    await startLocal();
    const localPc = createPc();
    localStream.getTracks().forEach(t => localPc.addTrack(t, localStream));
    await localPc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
    const answer = await localPc.createAnswer();
    await localPc.setLocalDescription(answer);
    send({type:'answer', from: usernameEl.value.trim(), to: from, sdp: localPc.localDescription});
  }

  async function onAnswer(msg){
    log('Получен answer');
    try{
      await createPc().setRemoteDescription(new RTCSessionDescription(msg.sdp));
    }catch(e){ log('Ошибка setRemoteDescription: ' + e.message); }
  }

  async function onRemoteIce(msg){
    try {
      await createPc().addIceCandidate(new RTCIceCandidate(msg.candidate));
      log('Добавлен удалённый ICE');
    } catch (e) { log('Ошибка addIceCandidate: ' + e.message); }
  }

  function hangup(){
    if(pc){ pc.close(); pc = null; }
    if(localStream){ localStream.getTracks().forEach(t => t.stop()); localStream=null; localVideo.srcObject=null; }
    remoteVideo.srcObject = null;
    log('Вызов завершён');
  }

  connectBtn.addEventListener('click', connectAndRegister);
  disconnectBtn.addEventListener('click', disconnectWs);
  callBtn.addEventListener('click', call);
  hangupBtn.addEventListener('click', hangup);
})();
</script>
</body>
</html>
